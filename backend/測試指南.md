# TixMaster RBAC/ABAC 測試指南

本指南涵蓋如何測試 TixMaster 後端的角色型存取控制（RBAC）與屬性型存取控制（ABAC）功能。

---

## 目錄
1. [快速開始](#快速開始)
2. [手動測試（curl）](#手動測試curl)
3. [自動化測試（Jest + supertest）](#自動化測試jest--supertest)
4. [常見問題與排除](#常見問題與排除)
5. [測試案例清單](#測試案例清單)

---

## 快速開始

### 前置要求
- Node.js 14+ 與 npm
- PostgreSQL 資料庫（已配置在 `backend/config/database.js`）
- `JWT_SECRET` 環境變數設定

### 啟動伺服器

在 `backend` 目錄執行：

```bash
# 設定環境變數（macOS/Linux zsh）
export JWT_SECRET="dev_secret_for_testing"
export DATABASE_URL="postgresql://user:password@localhost:5432/tixmaster"

# 安裝依賴（第一次執行）
npm install

# 啟動開發伺服器
npm run dev
# 或
npm start
```

伺服器預設在 `http://localhost:3000` 執行。

---

## 手動測試（curl）

### 1. 註冊與登入

#### 1.1 註冊新使用者

```bash
curl -s -X POST http://localhost:3000/api/users/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "testuser@example.com",
    "password": "SecurePass123!",
    "name": "Test User",
    "phone": "0911000001"
  }' | jq .
```

**預期回應**
```json
{
  "message": "User registered successfully",
  "user": {
    "id": 1,
    "email": "testuser@example.com",
    "name": "Test User",
    "phone": "0911000001",
    "role": "user",
    "created_at": "2025-11-25T10:00:00.000Z"
  }
}
```

#### 1.2 登入取得 Token

```bash
curl -s -X POST http://localhost:3000/api/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "testuser@example.com",
    "password": "SecurePass123!"
  }' | jq .
```

**預期回應**
```json
{
  "message": "Login successful",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "email": "testuser@example.com",
    "name": "Test User",
    "phone": "0911000001",
    "role": "user"
  }
}
```

**儲存 Token（供後續使用）**

```bash
USER_TOKEN=$(curl -s -X POST http://localhost:3000/api/users/login \
  -H "Content-Type: application/json" \
  -d '{"email":"testuser@example.com","password":"SecurePass123!"}' | jq -r .token)

echo "User Token: $USER_TOKEN"
```

### 2. ABAC 測試 — 擁有者才能存取自己的資源

#### 2.1 取得自己的個人檔案（應成功）

```bash
curl -s -X GET http://localhost:3000/api/users/profile \
  -H "Authorization: Bearer $USER_TOKEN" | jq .
```

**預期**：HTTP 200，回傳登入使用者的個人資料。

```json
{
  "user": {
    "id": 1,
    "email": "testuser@example.com",
    "name": "Test User",
    "phone": "0911000001",
    "role": "user",
    "attributes": {},
    "created_at": "2025-11-25T10:00:00.000Z"
  }
}
```

#### 2.2 更新自己的個人檔案（應成功）

```bash
curl -s -X PUT http://localhost:3000/api/users/profile \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User Updated",
    "phone": "0922000002"
  }' | jq .
```

**預期**：HTTP 200，回傳更新後的使用者資料。

#### 2.3 修改自己的密碼（應成功）

```bash
curl -s -X POST http://localhost:3000/api/users/change-password \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "currentPassword": "SecurePass123!",
    "newPassword": "NewSecurePass456!"
  }' | jq .
```

**預期**：HTTP 200。

#### 2.4 嘗試用非擁有者 Token 更新（應失敗）

首先建立第二個使用者：

```bash
curl -s -X POST http://localhost:3000/api/users/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "other@example.com",
    "password": "Pass456!",
    "name": "Other User"
  }' | jq .

# 登入取得 Token
OTHER_TOKEN=$(curl -s -X POST http://localhost:3000/api/users/login \
  -H "Content-Type: application/json" \
  -d '{"email":"other@example.com","password":"Pass456!"}' | jq -r .token)
```

嘗試用 OTHER_TOKEN 修改第一個使用者的檔案：

```bash
# 在 request body 指定目標使用者 ID（ABAC 會檢查是否為擁有者）
curl -s -X PUT http://localhost:3000/api/users/profile \
  -H "Authorization: Bearer $OTHER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "1",
    "name": "Malicious Change"
  }' -i
```

**預期**：HTTP 403 Forbidden
```json
{
  "error": "Forbidden",
  "message": "Access denied by policy"
}
```

### 3. RBAC 測試 — 角色型權限檢查

#### 3.1 建立 Admin Token（用於測試）

使用 Node.js 產生簽署過的 admin token：

```bash
# macOS/Linux zsh
ADMIN_TOKEN=$(node -e "
const jwt = require('jsonwebtoken');
const secret = process.env.JWT_SECRET || 'dev_secret_for_testing';
const token = jwt.sign(
  { userId: 999, email: 'admin@test.com', role: 'admin' },
  secret,
  { expiresIn: '7d' }
);
console.log(token);
")

echo "Admin Token: $ADMIN_TOKEN"
```

#### 3.2 Admin 取得所有使用者（應成功）

```bash
curl -s -X GET http://localhost:3000/api/users/all \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq .
```

**預期**：HTTP 200，回傳所有使用者列表。

#### 3.3 普通 User 嘗試取得所有使用者（應失敗）

```bash
curl -s -X GET http://localhost:3000/api/users/all \
  -H "Authorization: Bearer $USER_TOKEN" -i
```

**預期**：HTTP 403 Forbidden
```json
{
  "error": "Forbidden",
  "message": "Requires admin role"
}
```

#### 3.4 無 Token 嘗試存取（應失敗）

```bash
curl -s -X GET http://localhost:3000/api/users/all -i
```

**預期**：HTTP 401 Unauthorized
```json
{
  "error": "Access token required"
}
```

### 4. Feature Flags 管理 — 權限檢查

#### 4.1 查看 Feature Flags（無認證）

```bash
curl -s -X GET http://localhost:3000/api/feature-flags | jq .
```

**預期**：HTTP 200，列出所有啟用的 feature flags。

#### 4.2 普通 User 嘗試更新 Flag（應失敗）

```bash
curl -s -X PUT http://localhost:3000/api/feature-flags/some_feature \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"enabled": true}' -i
```

**預期**：HTTP 403 Forbidden（缺少 `manage_feature_flags` 權限）

#### 4.3 Admin 更新 Flag（應成功）

```bash
curl -s -X PUT http://localhost:3000/api/feature-flags/some_feature \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"enabled": true}' | jq .
```

**預期**：HTTP 200，回傳更新後的 flag。

---

## 自動化測試（Jest + supertest）

### 1. 安裝測試依賴

在 `backend` 目錄執行：

```bash
npm install --save-dev jest supertest cross-env
```

### 2. 更新 package.json

編輯 `backend/package.json`，在 `scripts` 區段加入：

```json
{
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "test": "cross-env NODE_ENV=test JWT_SECRET=test_secret jest --runInBand",
    "test:watch": "cross-env NODE_ENV=test JWT_SECRET=test_secret jest --watch"
  }
}
```

### 3. 建立測試檔案

建立 `backend/test/rbac_abac.test.js`：

```javascript
const request = require('supertest');
const express = require('express');
const jwt = require('jsonwebtoken');

// Import your Express app
// const app = require('../server'); 
// 或，如果 server.js 沒有 export，你可以建立一個測試用 app：

const app = express();
app.use(express.json());

// 簡單 mock：實際項目應使用真實 DB 或測試 DB
const JWT_SECRET = process.env.JWT_SECRET || 'test_secret';

// 模擬使用者 DB
const mockUsers = {};

// 模擬 auth middleware
const authenticateToken = (req, res, next) => {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];
    if (!token) return res.status(401).json({ error: 'Access token required' });
    
    jwt.verify(token, JWT_SECRET, (err, user) => {
        if (err) return res.status(403).json({ error: 'Invalid token' });
        req.user = user;
        next();
    });
};

// 模擬 RBAC middleware
const checkRole = (requiredRole) => {
    return (req, res, next) => {
        if (!req.user) return res.status(401).json({ error: 'Unauthorized' });
        if (req.user.role === 'admin') return next();
        if (req.user.role !== requiredRole) {
            return res.status(403).json({ error: 'Forbidden', message: `Requires ${requiredRole} role` });
        }
        next();
    };
};

// 模擬 ABAC middleware
const checkPolicy = (policyFn) => {
    return async (req, res, next) => {
        if (!req.user) return res.status(401).json({ error: 'Unauthorized' });
        try {
            const allowed = await policyFn(req.user, req);
            if (!allowed) return res.status(403).json({ error: 'Forbidden', message: 'Access denied by policy' });
            next();
        } catch (error) {
            res.status(500).json({ error: 'Internal Server Error' });
        }
    };
};

// Policy: isOwner
const isOwner = (user, req) => {
    const userId = user && (user.userId || user.id);
    if (req.params && req.params.id) {
        return String(userId) === String(req.params.id);
    }
    if (req.body && (req.body.id || req.body.userId)) {
        return String(userId) === String(req.body.id || req.body.userId);
    }
    return Boolean(userId);
};

// 測試路由
app.post('/api/users/register', (req, res) => {
    const { email, password, name } = req.body;
    if (!email || !password) return res.status(400).json({ error: 'Missing fields' });
    
    mockUsers[email] = { id: 1, email, name, role: 'user', password };
    res.status(201).json({ message: 'Registered', user: { id: 1, email, name, role: 'user' } });
});

app.post('/api/users/login', (req, res) => {
    const { email, password } = req.body;
    const user = mockUsers[email];
    if (!user || user.password !== password) return res.status(401).json({ error: 'Invalid credentials' });
    
    const token = jwt.sign({ userId: user.id, email, role: user.role }, JWT_SECRET, { expiresIn: '7d' });
    res.json({ message: 'Login successful', token, user: { id: user.id, email, name: user.name, role: user.role } });
});

app.put('/api/users/profile', authenticateToken, checkPolicy(isOwner), (req, res) => {
    const { name, phone } = req.body;
    res.json({ message: 'Profile updated', user: { id: req.user.userId, name, phone } });
});

app.get('/api/users/all', authenticateToken, checkRole('admin'), (req, res) => {
    res.json({ users: Object.values(mockUsers) });
});

// ===== 測試案例 =====

describe('RBAC/ABAC Tests', () => {
    
    describe('Registration & Login', () => {
        test('should register a new user', async () => {
            const res = await request(app)
                .post('/api/users/register')
                .send({ email: 'user@test.com', password: 'pass123', name: 'User' });
            
            expect(res.status).toBe(201);
            expect(res.body.user.role).toBe('user');
        });

        test('should login and return token', async () => {
            await request(app)
                .post('/api/users/register')
                .send({ email: 'user2@test.com', password: 'pass123', name: 'User2' });

            const res = await request(app)
                .post('/api/users/login')
                .send({ email: 'user2@test.com', password: 'pass123' });

            expect(res.status).toBe(200);
            expect(res.body.token).toBeDefined();
        });
    });

    describe('ABAC - Owner Access', () => {
        let userToken;

        beforeAll(async () => {
            await request(app)
                .post('/api/users/register')
                .send({ email: 'owner@test.com', password: 'pass123', name: 'Owner' });

            const loginRes = await request(app)
                .post('/api/users/login')
                .send({ email: 'owner@test.com', password: 'pass123' });

            userToken = loginRes.body.token;
        });

        test('should allow owner to update own profile', async () => {
            const res = await request(app)
                .put('/api/users/profile')
                .set('Authorization', `Bearer ${userToken}`)
                .send({ name: 'Updated Name' });

            expect(res.status).toBe(200);
            expect(res.body.user.name).toBe('Updated Name');
        });

        test('should deny non-owner from updating others profile', async () => {
            // Create another user
            await request(app)
                .post('/api/users/register')
                .send({ email: 'other@test.com', password: 'pass123', name: 'Other' });

            const otherRes = await request(app)
                .post('/api/users/login')
                .send({ email: 'other@test.com', password: 'pass123' });

            const otherToken = otherRes.body.token;

            // Try to update first user's profile with other's token and explicit ID
            const res = await request(app)
                .put('/api/users/profile')
                .set('Authorization', `Bearer ${otherToken}`)
                .send({ id: '1', name: 'Malicious' });

            expect(res.status).toBe(403);
            expect(res.body.message).toContain('Access denied');
        });

        test('should deny request without token', async () => {
            const res = await request(app)
                .put('/api/users/profile')
                .send({ name: 'No Token' });

            expect(res.status).toBe(401);
        });
    });

    describe('RBAC - Admin Only', () => {
        let adminToken, userToken;

        beforeAll(() => {
            // Create admin token
            adminToken = jwt.sign(
                { userId: 999, email: 'admin@test.com', role: 'admin' },
                JWT_SECRET,
                { expiresIn: '7d' }
            );

            // Create user token
            userToken = jwt.sign(
                { userId: 1, email: 'user@test.com', role: 'user' },
                JWT_SECRET,
                { expiresIn: '7d' }
            );
        });

        test('should allow admin to access /users/all', async () => {
            const res = await request(app)
                .get('/api/users/all')
                .set('Authorization', `Bearer ${adminToken}`);

            expect(res.status).toBe(200);
            expect(res.body.users).toBeDefined();
        });

        test('should deny user from accessing /users/all', async () => {
            const res = await request(app)
                .get('/api/users/all')
                .set('Authorization', `Bearer ${userToken}`);

            expect(res.status).toBe(403);
            expect(res.body.message).toContain('Requires admin role');
        });

        test('should deny request without token', async () => {
            const res = await request(app)
                .get('/api/users/all');

            expect(res.status).toBe(401);
        });
    });
});
```

### 4. 執行測試

```bash
# 執行全部測試
npm test

# Watch 模式（開發時自動重跑）
npm run test:watch

# 特定測試檔
npm test -- test/rbac_abac.test.js

# 顯示覆蓋率
npm test -- --coverage
```

**預期輸出**
```
 PASS  test/rbac_abac.test.js
  RBAC/ABAC Tests
    Registration & Login
      ✓ should register a new user
      ✓ should login and return token
    ABAC - Owner Access
      ✓ should allow owner to update own profile
      ✓ should deny non-owner from updating others profile
      ✓ should deny request without token
    RBAC - Admin Only
      ✓ should allow admin to access /users/all
      ✓ should deny user from accessing /users/all
      ✓ should deny request without token

Test Suites: 1 passed, 1 total
Tests:       8 passed, 8 total
```

---

## 常見問題與排除

### Q1: 「Invalid token」錯誤

**原因**：JWT_SECRET 不一致或過期。

**解決方案**：
- 確認 `JWT_SECRET` 環境變數在伺服器與測試客戶端都相同
- 檢查 token 是否過期（通常為 7 天）
- 重新產生 token

```bash
export JWT_SECRET="dev_secret_for_testing"
npm run dev
```

### Q2: 「Access token required」錯誤

**原因**：未提供 Authorization header 或格式不正確。

**解決方案**：
- Authorization header 格式必須為 `Bearer <token>`
- 確保 token 不包含空格或額外字元

```bash
# ✅ 正確
curl -H "Authorization: Bearer $TOKEN" ...

# ❌ 錯誤
curl -H "Authorization: $TOKEN" ...
curl -H "Bearer: $TOKEN" ...
```

### Q3: 「Forbidden」但預期成功

**原因**：角色或權限不符。

**排除步驟**：
1. 確認使用者的 `role` 欄位是否正確設定
2. 檢查 `ROLE_PERMISSIONS` 配置（`backend/config/roles.js`）
3. 確認 JWT payload 包含 `role` 欄位

```bash
# 檢查 token payload（macOS/Linux）
TOKEN="your_token_here"
node -e "console.log(JSON.parse(Buffer.from('$TOKEN'.split('.')[1], 'base64').toString()))"
```

### Q4: 資料庫連線失敗

**原因**：PostgreSQL 未執行或環境變數錯誤。

**解決方案**：
```bash
# 檢查 PostgreSQL 狀態（macOS Homebrew）
brew services list

# 啟動 PostgreSQL
brew services start postgresql

# 驗證連線
psql -U postgres -d postgres -c "SELECT 1"
```

### Q5: 測試中 DB 被污染

**建議**：使用 test database 或 mock 資料庫。

在 `backend/config/database.js` 添加邏輯：

```javascript
const isDev = process.env.NODE_ENV === 'development';
const isTest = process.env.NODE_ENV === 'test';

const config = {
    user: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASSWORD || '',
    host: process.env.DB_HOST || 'localhost',
    port: process.env.DB_PORT || 5432,
    database: isTest ? 'tixmaster_test' : (isDev ? 'tixmaster_dev' : 'tixmaster'),
};
```

然後建立測試資料庫：

```bash
createdb tixmaster_test
```

---

## 測試案例清單

完整測試 Checklist（手動與自動）：

| # | 功能 | 測試案例 | 預期結果 | 狀態 |
|---|------|---------|---------|------|
| 1 | 註冊 | 有效信箱、密碼、名稱 | 201，使用者建立 | ✓ |
| 2 | 登入 | 正確信箱/密碼 | 200，token 返回 | ✓ |
| 3 | 登入 | 錯誤密碼 | 401 | ✓ |
| 4 | 個人檔案 | 已認證使用者取得自己的檔案 | 200，檔案回傳 | ✓ |
| 5 | 個人檔案 | 未認證嘗試取得檔案 | 401 | ✓ |
| 6 | 更新檔案 | 擁有者更新自己的檔案 | 200，更新成功 | ✓ |
| 7 | 更新檔案 | 非擁有者嘗試更新他人檔案 | 403 | ✓ |
| 8 | 改密碼 | 擁有者用正確舊密碼改密 | 200 | ✓ |
| 9 | 改密碼 | 錯誤舊密碼 | 401 | ✓ |
| 10 | 全使用者列表 | Admin 取得列表 | 200，列表返回 | ✓ |
| 11 | 全使用者列表 | 普通 User 取得列表 | 403 | ✓ |
| 12 | Feature Flags 更新 | Admin 更新 flag | 200 | ✓ |
| 13 | Feature Flags 更新 | User 更新 flag | 403 | ✓ |
| 14 | OAuth Token | 包含 role 欄位 | token 中有 role | ✓ |

---

## 延伸閱讀

- [JWT 官方文件](https://jwt.io/)
- [Express 中介軟體](https://expressjs.com/en/guide/using-middleware.html)
- [Jest 測試框架](https://jestjs.io/)
- [supertest 文件](https://github.com/visionmedia/supertest)

---

**最後更新**：2025-11-25  
**維護者**：TixMaster 開發團隊
