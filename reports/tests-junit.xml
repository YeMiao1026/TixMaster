<?xml version="1.0" encoding="utf-8"?><testsuites name="pytest tests"><testsuite name="pytest" errors="0" failures="4" skipped="0" tests="10" time="2.878" timestamp="2025-11-25T11:37:36.026503+08:00" hostname="DESKTOP-1IL05A9"><testcase classname="tests.test_health" name="test_health_ok" time="1.132" /><testcase classname="tests.test_security" name="test_protected_route_requires_auth" time="0.027" /><testcase classname="tests.test_security" name="test_put_enabled_type_validation" time="0.021"><failure message="assert 403 == 400&#10; +  where 403 = &lt;Response [403]&gt;.status_code">base_url = 'http://localhost:3000'
admin_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZW1haWwiOiJhZG1pbkBleGFtcGxlLmNvbSIsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc2NDA0MTg1Mn0.D5cSG4hBxyzYVHOfLT90ck3ExEVNXvTeteJLLJA8A_4'

    def test_put_enabled_type_validation(base_url, admin_token):
        if not admin_token:
            pytest.skip('ADMIN_TOKEN not set; skipping validation test that requires auth')
        headers = {'Authorization': f"Bearer {admin_token}"}
        payload = {'enabled': 'not_boolean'}
        r = requests.put(f"{base_url}/api/feature-flags/some_flag", json=payload, headers=headers, timeout=5)
&gt;       assert r.status_code == 400
E       assert 403 == 400
E        +  where 403 = &lt;Response [403]&gt;.status_code

tests\test_security.py:16: AssertionError</failure></testcase><testcase classname="tests.test_toggle" name="test_get_all_flags" time="0.246" /><testcase classname="tests.test_toggle" name="test_get_single_flag_not_found" time="0.179" /><testcase classname="tests.test_toggle" name="test_update_requires_auth" time="0.011" /><testcase classname="tests.test_toggle" name="test_update_with_admin_token" time="0.014"><failure message="assert 403 == 200&#10; +  where 403 = &lt;Response [403]&gt;.status_code">base_url = 'http://localhost:3000'
admin_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZW1haWwiOiJhZG1pbkBleGFtcGxlLmNvbSIsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc2NDA0MTg1Mn0.D5cSG4hBxyzYVHOfLT90ck3ExEVNXvTeteJLLJA8A_4'

    @pytest.mark.toggle
    def test_update_with_admin_token(base_url, admin_token):
        if not admin_token:
            pytest.skip('ADMIN_TOKEN not set; skipping authenticated update test')
        headers = {'Authorization': f"Bearer {admin_token}"}
        payload = {'enabled': True}
        r = requests.put(f"{base_url}/api/feature-flags/some_flag", json=payload, headers=headers, timeout=5)
&gt;       assert r.status_code == 200
E       assert 403 == 200
E        +  where 403 = &lt;Response [403]&gt;.status_code

tests\test_toggle.py:33: AssertionError</failure></testcase><testcase classname="tests.test_toggle" name="test_get_flag_structure" time="0.162" /><testcase classname="tests.test_toggle" name="test_put_missing_enabled_requires_validation" time="0.026"><failure message="assert 403 == 400&#10; +  where 403 = &lt;Response [403]&gt;.status_code">base_url = 'http://localhost:3000'
admin_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZW1haWwiOiJhZG1pbkBleGFtcGxlLmNvbSIsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc2NDA0MTg1Mn0.D5cSG4hBxyzYVHOfLT90ck3ExEVNXvTeteJLLJA8A_4'

    def test_put_missing_enabled_requires_validation(base_url, admin_token):
        """如果沒有提供 `enabled` 欄位，API 應該回傳 400（需 admin token）"""
        if not admin_token:
            pytest.skip('ADMIN_TOKEN not set; skipping validation test that requires auth')
        headers = {'Authorization': f"Bearer {admin_token}"}
        r = requests.put(f"{base_url}/api/feature-flags/some_flag", json={}, headers=headers, timeout=5)
&gt;       assert r.status_code == 400
E       assert 403 == 400
E        +  where 403 = &lt;Response [403]&gt;.status_code

tests\test_toggle.py:59: AssertionError</failure></testcase><testcase classname="tests.test_toggle" name="test_toggle_sequence_with_verification" time="0.025"><failure message="assert 403 == 200&#10; +  where 403 = &lt;Response [403]&gt;.status_code">base_url = 'http://localhost:3000'
admin_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZW1haWwiOiJhZG1pbkBleGFtcGxlLmNvbSIsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc2NDA0MTg1Mn0.D5cSG4hBxyzYVHOfLT90ck3ExEVNXvTeteJLLJA8A_4'

    def test_toggle_sequence_with_verification(base_url, admin_token):
        """使用 admin token 依序切換一個已知 flag (ENABLE_CHECKOUT_TIMER) 並在每次切換後驗證狀態"""
        if not admin_token:
            pytest.skip('ADMIN_TOKEN not set; skipping authenticated toggle sequence test')
        headers = {'Authorization': f"Bearer {admin_token}"}
        flag_key = 'ENABLE_CHECKOUT_TIMER'
    
        # 1) 設為 True
        r = requests.put(f"{base_url}/api/feature-flags/{flag_key}", json={'enabled': True}, headers=headers, timeout=5)
&gt;       assert r.status_code == 200
E       assert 403 == 200
E        +  where 403 = &lt;Response [403]&gt;.status_code

tests\test_toggle.py:71: AssertionError</failure></testcase></testsuite></testsuites>