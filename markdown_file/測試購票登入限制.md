# 購票登入限制 - 測試計劃

## 修改摘要

已成功實作「使用者必須先登入才能購票」的功能。以下是所做的修改：

### 1. 後端修改
- **無需修改**：`backend/routes/orders.js` 的 `POST /api/orders` 路由已經有 `authenticateToken` 中間件保護
- 若未登入，後端會返回 401 或 403 錯誤

### 2. 前端修改

#### 新增文件
- **`frontend/login-required.html`**：創建了一個友善的登入提示頁面
  - 顯示需要登入的原因
  - 提供登入和註冊按鈕
  - 支援返回 URL 功能（登入後自動回到購票頁面）

#### 修改的文件

1. **`frontend/checkout.html`**
   - 在 `initCheckoutPage()` 函數開頭檢查登入狀態
   - 未登入時重定向到 `login-required.html`
   - 修改 `processPayment()` 函數，實際調用後端 API 建立訂單
   - 包含完整的錯誤處理（401/403 錯誤會要求重新登入）
   - 修正變數重複宣告問題（`currentUser` 改為 `userData`）

2. **`frontend/event-detail.html`**
   - 在 `buyTickets()` 函數開頭檢查登入狀態
   - 未登入時提早重定向到 `login-required.html`
   - 提供更好的使用者體驗（不用等到結帳頁面才發現要登入）

3. **`frontend/login.html`**
   - 支援 `returnUrl` 查詢參數
   - 登入成功後自動跳轉回原來想前往的頁面
   - 也支援從 localStorage 讀取返回 URL

4. **`frontend/register.html`**
   - 支援 `returnUrl` 查詢參數
   - 將返回 URL 儲存到 localStorage（因為 OAuth 流程會跳轉）

5. **`frontend/login-required.html`**
   - 登入和註冊按鈕都包含返回 URL
   - 自動檢測已登入狀態並跳轉

## 測試計劃

### 測試案例 1: 未登入時無法購票
**步驟：**
1. 清除瀏覽器 localStorage（確保未登入狀態）
2. 前往首頁 `index.html`
3. 點擊任一活動
4. 在活動詳情頁面點擊「立即購票」按鈕

**預期結果：**
- 應該被重定向到 `login-required.html` 頁面
- 看到友善的提示訊息，說明需要登入
- 頁面顯示登入和註冊按鈕

### 測試案例 2: 登入後成功購票
**步驟：**
1. 從測試案例 1 的 `login-required.html` 頁面點擊「立即登入」
2. 完成登入流程
3. 登入成功後應自動返回購票頁面

**預期結果：**
- 登入成功後自動跳轉到 `checkout.html`
- 能看到訂單資訊
- 能填寫購買人資訊
- 點擊「確認付款」後能成功建立訂單

### 測試案例 3: 直接訪問結帳頁面（未登入）
**步驟：**
1. 清除 localStorage（確保未登入）
2. 直接在網址列輸入 `checkout.html?eventId=1&quantity=2`

**預期結果：**
- 應該立即被重定向到 `login-required.html`
- 登入後應返回 `checkout.html?eventId=1&quantity=2`

### 測試案例 4: Token 過期處理
**步驟：**
1. 登入系統
2. 手動將 localStorage 中的 token 改為無效值
3. 嘗試購票

**預期結果：**
- 點擊「確認付款」後，後端返回 401 錯誤
- 前端應顯示「登入狀態已過期」提示
- 自動清除 token 並重定向到登入頁面

### 測試案例 5: 註冊新帳號後購票
**步驟：**
1. 清除 localStorage
2. 訪問活動頁面，點擊購票
3. 在 `login-required.html` 點擊「註冊新帳號」
4. 完成註冊流程

**預期結果：**
- 註冊成功後應返回購票頁面
- 能正常完成購票流程

## 測試命令

```bash
# 啟動後端服務器
cd backend
npm start

# 訪問前端
# 打開瀏覽器訪問 http://localhost:3000
```

## 驗證點

- [ ] 未登入時無法訪問 checkout.html
- [ ] 未登入時點擊購票按鈕會顯示登入提示頁面
- [ ] 登入提示頁面設計友善，說明清楚
- [ ] 登入後能自動返回購票頁面
- [ ] 註冊後能自動返回購票頁面
- [ ] 實際購票時會調用後端 API
- [ ] Token 過期時有適當的錯誤處理
- [ ] 購票成功後顯示訂單編號

## 安全性檢查

✅ **後端驗證**：所有訂單建立請求都經過 `authenticateToken` 中間件驗證
✅ **前端檢查**：提供良好的使用者體驗，避免無謂的 API 請求
✅ **錯誤處理**：適當處理 401/403 錯誤，清除過期 token
✅ **返回 URL**：安全地處理重定向，避免開放式重定向漏洞

## 注意事項

1. **開發環境測試**：在本地測試時需要確保後端服務器正在運行
2. **Token 儲存**：Token 儲存在 localStorage 中，關閉瀏覽器後仍會保持登入狀態
3. **清除測試資料**：測試時可以使用瀏覽器開發者工具清除 localStorage

## 已修改的文件清單

```
frontend/
├── login-required.html       (新增)
├── checkout.html             (修改)
├── event-detail.html         (修改)
├── login.html                (修改)
└── register.html             (修改)
```

後端文件無需修改，已有適當的認證機制。
