# ğŸ“Š TixMaster SLI/SLO/SLA æ–‡ä»¶

## ğŸ“‹ ç›®éŒ„
1. [SLI (Service Level Indicators) - æœå‹™æ°´æº–æŒ‡æ¨™](#sli-æœå‹™æ°´æº–æŒ‡æ¨™)
2. [SLO (Service Level Objectives) - æœå‹™æ°´æº–ç›®æ¨™](#slo-æœå‹™æ°´æº–ç›®æ¨™)
3. [SLA (Service Level Agreements) - æœå‹™æ°´æº–å”è­°](#sla-æœå‹™æ°´æº–å”è­°)
4. [ç›£æ§èˆ‡è­¦å ±ç­–ç•¥](#ç›£æ§èˆ‡è­¦å ±ç­–ç•¥)
5. [Error Budget - éŒ¯èª¤é ç®—](#error-budget-éŒ¯èª¤é ç®—)

---

## ğŸ¯ SLI (Service Level Indicators) - æœå‹™æ°´æº–æŒ‡æ¨™

SLI æ˜¯ç”¨ä¾†è¡¡é‡æœå‹™å“è³ªçš„å…·é«”æŒ‡æ¨™ã€‚æˆ‘å€‘åŸºæ–¼ **Google's Four Golden Signals** å®šç¾©ä»¥ä¸‹ SLIï¼š

### 1. å¯ç”¨æ€§ (Availability)

**å®šç¾©**: æœå‹™èƒ½å¤ æ­£å¸¸å›æ‡‰è«‹æ±‚çš„æ¯”ä¾‹

**æ¸¬é‡æ–¹å¼**:
```
å¯ç”¨æ€§ = (æˆåŠŸè«‹æ±‚æ•¸) / (ç¸½è«‹æ±‚æ•¸) Ã— 100%
```

**PromQL æŸ¥è©¢**:
```promql
# å¯ç”¨æ€§ç™¾åˆ†æ¯” (æ’é™¤ 4xx éŒ¯èª¤ï¼Œå› ç‚ºé€™æ˜¯å®¢æˆ¶ç«¯å•é¡Œ)
100 * (
  sum(rate(http_requests_total[5m]))
  - sum(rate(http_errors_total{status_code=~"5.."}[5m]))
) / sum(rate(http_requests_total[5m]))
```

**Metric ä¾†æº**: `http_requests_total`, `http_errors_total`

---

### 2. å»¶é² (Latency)

**å®šç¾©**: è«‹æ±‚å¾ç™¼é€åˆ°æ”¶åˆ°å›æ‡‰çš„æ™‚é–“

**æ¸¬é‡æ–¹å¼**:
- **P50 (ä¸­ä½æ•¸)**: 50% çš„è«‹æ±‚å›æ‡‰æ™‚é–“
- **P95**: 95% çš„è«‹æ±‚å›æ‡‰æ™‚é–“
- **P99**: 99% çš„è«‹æ±‚å›æ‡‰æ™‚é–“

**PromQL æŸ¥è©¢**:
```promql
# P95 å»¶é² (æ¯«ç§’)
histogram_quantile(0.95,
  sum(rate(http_request_duration_ms_bucket[5m])) by (le, route)
)

# P99 å»¶é² (æ¯«ç§’)
histogram_quantile(0.99,
  sum(rate(http_request_duration_ms_bucket[5m])) by (le, route)
)
```

**Metric ä¾†æº**: `http_request_duration_ms_bucket`

---

### 3. æµé‡ (Traffic)

**å®šç¾©**: æœå‹™æ¯ç§’è™•ç†çš„è«‹æ±‚æ•¸é‡

**æ¸¬é‡æ–¹å¼**:
```
æµé‡ (RPS) = è«‹æ±‚ç¸½æ•¸ / æ™‚é–“å€é–“ (ç§’)
```

**PromQL æŸ¥è©¢**:
```promql
# æ¯ç§’è«‹æ±‚æ•¸ (Requests Per Second)
sum(rate(http_requests_total[1m]))
```

**Metric ä¾†æº**: `http_requests_total`

---

### 4. éŒ¯èª¤ç‡ (Error Rate)

**å®šç¾©**: å¤±æ•—è«‹æ±‚ä½”ç¸½è«‹æ±‚çš„æ¯”ä¾‹

**æ¸¬é‡æ–¹å¼**:
```
éŒ¯èª¤ç‡ = (5xx éŒ¯èª¤æ•¸) / (ç¸½è«‹æ±‚æ•¸) Ã— 100%
```

**PromQL æŸ¥è©¢**:
```promql
# 5xx éŒ¯èª¤ç‡ç™¾åˆ†æ¯”
100 * sum(rate(http_errors_total{status_code=~"5.."}[5m]))
  / sum(rate(http_requests_total[5m]))
```

**Metric ä¾†æº**: `http_errors_total`, `http_requests_total`

---

### 5. é£½å’Œåº¦ (Saturation)

**å®šç¾©**: ç³»çµ±è³‡æºä½¿ç”¨ç¨‹åº¦

**æ¸¬é‡æ–¹å¼**:
- **CPU ä½¿ç”¨ç‡**: CPU æ¶ˆè€—ç™¾åˆ†æ¯”
- **è¨˜æ†¶é«”ä½¿ç”¨ç‡**: è¨˜æ†¶é«”æ¶ˆè€—
- **æ´»èºè«‹æ±‚æ•¸**: åŒæ™‚è™•ç†çš„è«‹æ±‚æ•¸

**PromQL æŸ¥è©¢**:
```promql
# CPU ä½¿ç”¨ç‡
100 * (1 - avg(rate(process_cpu_user_seconds_total[5m])))

# è¨˜æ†¶é«”ä½¿ç”¨é‡ (bytes)
process_resident_memory_bytes

# æ´»èºè«‹æ±‚æ•¸
http_requests_active
```

**Metric ä¾†æº**: `process_cpu_user_seconds_total`, `process_resident_memory_bytes`, `http_requests_active`

---

## ğŸ¯ SLO (Service Level Objectives) - æœå‹™æ°´æº–ç›®æ¨™

SLO æ˜¯æˆ‘å€‘è¨­å®šçš„ç›®æ¨™å€¼ï¼Œç”¨ä¾†ç¢ºä¿æœå‹™å“è³ªã€‚

### 1. å¯ç”¨æ€§ SLO

| æ™‚é–“ç¯„åœ | ç›®æ¨™å¯ç”¨æ€§ | å…è¨±åœæ©Ÿæ™‚é–“ |
|---------|-----------|-------------|
| æ¯æœˆ (30 å¤©) | **99.5%** | 3.6 å°æ™‚ |
| æ¯é€± (7 å¤©) | **99.5%** | 50.4 åˆ†é˜ |
| æ¯æ—¥ (24 å°æ™‚) | **99.5%** | 7.2 åˆ†é˜ |

**è¨ˆç®—æ–¹å¼**:
```
åœæ©Ÿæ™‚é–“ = ç¸½æ™‚é–“ Ã— (1 - å¯ç”¨æ€§%)
æ¯æœˆåœæ©Ÿ = 30å¤© Ã— 24å°æ™‚ Ã— (1 - 0.995) = 3.6 å°æ™‚
```

**è­¦å ±é–¾å€¼**: å¯ç”¨æ€§ < 99.5% æ™‚è§¸ç™¼è­¦å ±

---

### 2. å»¶é² SLO

| Percentile | ç›®æ¨™å»¶é² | èªªæ˜ |
|-----------|---------|------|
| **P50** | < 100 ms | 50% çš„è«‹æ±‚å¿…é ˆåœ¨ 100ms å…§å®Œæˆ |
| **P95** | < 500 ms | 95% çš„è«‹æ±‚å¿…é ˆåœ¨ 500ms å…§å®Œæˆ |
| **P99** | < 1000 ms | 99% çš„è«‹æ±‚å¿…é ˆåœ¨ 1s å…§å®Œæˆ |

**ä¾è·¯ç”±åˆ†é¡**:

| è·¯ç”± | P95 ç›®æ¨™ | ç†ç”± |
|------|---------|------|
| `/health` | < 50 ms | å¥åº·æª¢æŸ¥æ‡‰è©²æ¥µå¿« |
| `/api/events` | < 300 ms | è³‡æ–™åº«æŸ¥è©¢ |
| `/api/orders` | < 500 ms | æ¶‰åŠäº¤æ˜“è™•ç† |
| `/metrics` | < 100 ms | ç›£æ§ç«¯é» |

**è­¦å ±é–¾å€¼**: P95 å»¶é² > 500ms æ™‚è§¸ç™¼è­¦å ±

---

### 3. æµé‡ SLO

| æŒ‡æ¨™ | ç›®æ¨™å€¼ | èªªæ˜ |
|------|-------|------|
| **æ­£å¸¸æµé‡** | 10-100 RPS | ä¸€èˆ¬ç‡Ÿé‹æµé‡ |
| **é«˜å³°æµé‡** | 100-500 RPS | æ´»å‹•é–‹è³£æ™‚ |
| **æœ€å¤§å®¹é‡** | 1000 RPS | ç³»çµ±æ‰¿è¼‰ä¸Šé™ |

**è­¦å ±é–¾å€¼**:
- æµé‡ > 800 RPS æ™‚ç™¼å‡ºå®¹é‡è­¦å‘Š
- æµé‡ > 1000 RPS æ™‚ç™¼å‡ºéè¼‰è­¦å ±

---

### 4. éŒ¯èª¤ç‡ SLO

| éŒ¯èª¤é¡å‹ | ç›®æ¨™éŒ¯èª¤ç‡ | èªªæ˜ |
|---------|-----------|------|
| **5xx éŒ¯èª¤** | < 0.1% | ä¼ºæœå™¨éŒ¯èª¤å¿…é ˆæ¥µä½ |
| **4xx éŒ¯èª¤** | < 5% | å®¢æˆ¶ç«¯éŒ¯èª¤å¯å®¹å¿ç¯„åœ |

**è­¦å ±é–¾å€¼**:
- 5xx éŒ¯èª¤ç‡ > 0.5% æ™‚è§¸ç™¼è­¦å ±
- 5xx éŒ¯èª¤ç‡ > 1% æ™‚è§¸ç™¼ç·Šæ€¥è­¦å ±

---

### 5. é£½å’Œåº¦ SLO

| è³‡æº | ç›®æ¨™ä½¿ç”¨ç‡ | è­¦å‘Šé–¾å€¼ | å±éšªé–¾å€¼ |
|------|-----------|---------|---------|
| **CPU** | < 70% | 80% | 90% |
| **è¨˜æ†¶é«”** | < 80% | 85% | 95% |
| **æ´»èºè«‹æ±‚** | < 10 | 15 | 20 |

---

## ğŸ“œ SLA (Service Level Agreements) - æœå‹™æ°´æº–å”è­°

SLA æ˜¯æˆ‘å€‘å°ä½¿ç”¨è€…çš„æ‰¿è«¾ï¼Œé•å SLA å¯èƒ½éœ€è¦è³ å„Ÿã€‚

### 1. æœå‹™å¯ç”¨æ€§æ‰¿è«¾

**æ‰¿è«¾å…§å®¹**:
- TixMaster æä¾› **99.5%** çš„æœˆåº¦å¯ç”¨æ€§ä¿è­‰
- è¨ˆç•«æ€§ç¶­è­·ä¸è¨ˆå…¥åœæ©Ÿæ™‚é–“ï¼ˆéœ€æå‰ 24 å°æ™‚é€šçŸ¥ï¼‰

**è¨ˆç®—æ–¹å¼**:
```
æœˆåº¦å¯ç”¨æ€§ = (ç¸½æ™‚é–“ - éè¨ˆç•«æ€§åœæ©Ÿæ™‚é–“) / ç¸½æ™‚é–“ Ã— 100%
```

**è³ å„Ÿæ–¹æ¡ˆ**:

| å¯¦éš›å¯ç”¨æ€§ | æœå‹™é»æ•¸é€€æ¬¾ |
|-----------|------------|
| 99.5% - 99.0% | 10% |
| 99.0% - 95.0% | 25% |
| < 95.0% | 50% |

---

### 2. æ•ˆèƒ½æ‰¿è«¾

**æ‰¿è«¾å…§å®¹**:
- API å›æ‡‰æ™‚é–“ P95 < 500ms
- API å›æ‡‰æ™‚é–“ P99 < 1000ms

**ä¾‹å¤–æƒ…æ³**:
- ä½¿ç”¨è€…ç¶²è·¯å•é¡Œ
- ç¬¬ä¸‰æ–¹æœå‹™å»¶é²ï¼ˆOAuthã€æ”¯ä»˜é–˜é“ï¼‰
- DDoS æ”»æ“ŠæœŸé–“

---

### 3. è³‡æ–™å®Œæ•´æ€§æ‰¿è«¾

**æ‰¿è«¾å…§å®¹**:
- è¨‚å–®è³‡æ–™ä¸éºå¤±ï¼ˆ99.999% å¯é æ€§ï¼‰
- è³‡æ–™åº«æ¯æ—¥å‚™ä»½
- ç½é›£æ¢å¾©æ™‚é–“ç›®æ¨™ (RTO): < 4 å°æ™‚
- æ¢å¾©é»ç›®æ¨™ (RPO): < 1 å°æ™‚

---

### 4. æ”¯æ´å›æ‡‰æ™‚é–“

| åš´é‡ç¨‹åº¦ | é¦–æ¬¡å›æ‡‰æ™‚é–“ | è§£æ±ºæ™‚é–“ç›®æ¨™ |
|---------|------------|------------|
| **P0 (ç·Šæ€¥)** | 15 åˆ†é˜ | 2 å°æ™‚ |
| **P1 (é«˜)** | 1 å°æ™‚ | 8 å°æ™‚ |
| **P2 (ä¸­)** | 4 å°æ™‚ | 2 å¤© |
| **P3 (ä½)** | 1 å¤© | 1 é€± |

**åš´é‡ç¨‹åº¦å®šç¾©**:
- **P0**: æœå‹™å®Œå…¨ä¸­æ–·ï¼Œç„¡æ³•è³¼ç¥¨
- **P1**: æ ¸å¿ƒåŠŸèƒ½å—å½±éŸ¿ï¼Œéƒ¨åˆ†ç”¨æˆ¶ç„¡æ³•ä½¿ç”¨
- **P2**: æ¬¡è¦åŠŸèƒ½å•é¡Œï¼Œæœ‰æ›¿ä»£æ–¹æ¡ˆ
- **P3**: ä¸€èˆ¬æ€§å•é¡Œæˆ–åŠŸèƒ½è«‹æ±‚

---

## ğŸš¨ ç›£æ§èˆ‡è­¦å ±ç­–ç•¥

### è­¦å ±åˆ†ç´š

#### ğŸ”´ P0 - ç·Šæ€¥è­¦å ± (Critical)
- **æ¢ä»¶**:
  - å¯ç”¨æ€§ < 95%
  - 5xx éŒ¯èª¤ç‡ > 5%
  - æœå‹™å®Œå…¨å®•æ©Ÿ
- **é€šçŸ¥æ–¹å¼**: SMS + Email + Slack
- **å›æ‡‰æ™‚é–“**: 15 åˆ†é˜å…§

#### ğŸŸ  P1 - é«˜å„ªå…ˆç´šè­¦å ± (High)
- **æ¢ä»¶**:
  - å¯ç”¨æ€§ 95-99%
  - 5xx éŒ¯èª¤ç‡ 1-5%
  - P95 å»¶é² > 1000ms
- **é€šçŸ¥æ–¹å¼**: Email + Slack
- **å›æ‡‰æ™‚é–“**: 1 å°æ™‚å…§

#### ğŸŸ¡ P2 - è­¦å‘Š (Warning)
- **æ¢ä»¶**:
  - CPU ä½¿ç”¨ç‡ > 80%
  - è¨˜æ†¶é«”ä½¿ç”¨ç‡ > 85%
  - P95 å»¶é² 500-1000ms
- **é€šçŸ¥æ–¹å¼**: Slack
- **å›æ‡‰æ™‚é–“**: 4 å°æ™‚å…§

#### ğŸ”µ P3 - è³‡è¨Š (Info)
- **æ¢ä»¶**:
  - æµé‡ç•°å¸¸é«˜ (> 500 RPS)
  - è³‡æ–™åº«é€£ç·šæ± æ¥è¿‘ä¸Šé™
- **é€šçŸ¥æ–¹å¼**: Grafana Dashboard
- **å›æ‡‰æ™‚é–“**: 1 å¤©å…§

---

### è­¦å ±è¦å‰‡ç¯„ä¾‹

```yaml
# Prometheus Alert Rules
groups:
  - name: tixmaster_alerts
    interval: 30s
    rules:
      # é«˜éŒ¯èª¤ç‡è­¦å ±
      - alert: HighErrorRate
        expr: |
          100 * sum(rate(http_errors_total{status_code=~"5.."}[5m]))
            / sum(rate(http_requests_total[5m])) > 1
        for: 5m
        labels:
          severity: critical
          priority: P0
        annotations:
          summary: "é«˜éŒ¯èª¤ç‡ ({{ $value }}%)"
          description: "5xx éŒ¯èª¤ç‡è¶…é 1%ï¼Œç›®å‰ç‚º {{ $value }}%"

      # é«˜å»¶é²è­¦å ±
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_ms_bucket[5m])) by (le)
          ) > 500
        for: 10m
        labels:
          severity: warning
          priority: P2
        annotations:
          summary: "P95 å»¶é²éé«˜ ({{ $value }}ms)"
          description: "API å›æ‡‰æ™‚é–“ P95 è¶…é 500ms"

      # æœå‹™å®•æ©Ÿè­¦å ±
      - alert: ServiceDown
        expr: up{job="tixmaster-backend"} == 0
        for: 1m
        labels:
          severity: critical
          priority: P0
        annotations:
          summary: "TixMaster æœå‹™å®•æ©Ÿ"
          description: "Backend æœå‹™ç„¡æ³•é€£æ¥"
```

---

## ğŸ’° Error Budget - éŒ¯èª¤é ç®—

### éŒ¯èª¤é ç®—æ¦‚å¿µ

**å®šç¾©**: åœ¨ä¸é•å SLO çš„å‰æä¸‹ï¼Œå…è¨±çš„éŒ¯èª¤æ•¸é‡

**è¨ˆç®—æ–¹å¼**:
```
éŒ¯èª¤é ç®— = (1 - SLO) Ã— ç¸½è«‹æ±‚æ•¸

ç¯„ä¾‹ï¼š
- æœˆåº¦ SLO: 99.5% å¯ç”¨æ€§
- æœˆåº¦ç¸½è«‹æ±‚: 1,000,000 æ¬¡
- å…è¨±å¤±æ•—: 1,000,000 Ã— (1 - 0.995) = 5,000 æ¬¡
```

### æœˆåº¦éŒ¯èª¤é ç®—è¿½è¹¤

| æŒ‡æ¨™ | SLO ç›®æ¨™ | éŒ¯èª¤é ç®— | ç•¶å‰ä½¿ç”¨ | å‰©é¤˜é ç®— |
|------|---------|---------|---------|---------|
| å¯ç”¨æ€§ | 99.5% | 0.5% | 0.2% | 0.3% âœ… |
| 5xx éŒ¯èª¤ | < 0.1% | 0.1% | 0.05% | 0.05% âœ… |
| P95 å»¶é² | < 500ms | - | 320ms | âœ… |

**éŒ¯èª¤é ç®—æ”¿ç­–**:

| å‰©é¤˜é ç®— | è¡Œå‹• |
|---------|------|
| > 50% | âœ… å¯ä»¥é€²è¡Œæ–°åŠŸèƒ½é–‹ç™¼å’Œéƒ¨ç½² |
| 25-50% | âš ï¸ æ¸›å°‘è®Šæ›´é »ç‡ï¼ŒåŠ å¼·æ¸¬è©¦ |
| 10-25% | ğŸš« æš«åœæ–°åŠŸèƒ½ï¼Œå°ˆæ³¨ç©©å®šæ€§ |
| < 10% | ğŸ”´ åœæ­¢æ‰€æœ‰è®Šæ›´ï¼Œä¿®å¾©å•é¡Œ |

---

## ğŸ“ˆ SLI/SLO å„€è¡¨æ¿

### Grafana Panel é…ç½®

**SLO é”æˆç‡ Panel**:
```json
{
  "title": "SLO é”æˆç‡",
  "targets": [
    {
      "expr": "100 * (sum(rate(http_requests_total[5m])) - sum(rate(http_errors_total{status_code=~\"5..\"}[5m]))) / sum(rate(http_requests_total[5m]))",
      "legendFormat": "å¯ç”¨æ€§"
    }
  ],
  "thresholds": [
    { "value": 99.5, "color": "green" },
    { "value": 99.0, "color": "yellow" },
    { "value": 95.0, "color": "red" }
  ]
}
```

**éŒ¯èª¤é ç®— Panel**:
```json
{
  "title": "éŒ¯èª¤é ç®—å‰©é¤˜",
  "targets": [
    {
      "expr": "100 - (100 * sum(increase(http_errors_total{status_code=~\"5..\"}[30d])) / sum(increase(http_requests_total[30d])))",
      "legendFormat": "å‰©é¤˜é ç®— %"
    }
  ]
}
```

---

## ğŸ“ å®šæœŸæª¢è¨

### é€±å ± (Weekly Review)
- âœ… æª¢è¦–æœ¬é€± SLI é”æˆç‹€æ³
- âœ… åˆ†æéŒ¯èª¤é ç®—æ¶ˆè€—åŸå› 
- âœ… æª¢è¨è­¦å ±æœ‰æ•ˆæ€§ï¼ˆèª¤å ±ç‡ï¼‰

### æœˆå ± (Monthly Review)
- âœ… è©•ä¼° SLO æ˜¯å¦åˆç†
- âœ… èª¿æ•´è­¦å ±é–¾å€¼
- âœ… æ›´æ–° SLA å ±å‘Š
- âœ… è¦åŠƒæ”¹é€²æªæ–½

### å­£åº¦æª¢è¨ (Quarterly Review)
- âœ… é‡æ–°è©•ä¼° SLO ç›®æ¨™
- âœ… åˆ†æé•·æœŸè¶¨å‹¢
- âœ… åˆ¶å®šå®¹é‡è¦åŠƒ

---

**æ–‡ä»¶ç‰ˆæœ¬**: 1.0
**æœ€å¾Œæ›´æ–°**: 2025-11-30
**è² è²¬äºº**: TixMaster DevOps Team
