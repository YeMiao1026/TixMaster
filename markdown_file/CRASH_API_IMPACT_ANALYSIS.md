# 🔍 單次觸發 Crash API 對生產環境的影響分析

## 📊 影響評估

### ✅ 單次觸發的影響（有自動重啟）

| 部署方式 | 影響時間 | 資源消耗 | 資料風險 | 總評 |
|---------|---------|---------|---------|------|
| **PM2** | 1-2 秒 | 低 | 極低 | 🟢 可接受 |
| **Docker** | 2-5 秒 | 低 | 極低 | 🟢 可接受 |
| **Railway** | 5-15 秒 | 中 | 低 | 🟡 可接受（短暫中斷） |
| **Kubernetes (多副本)** | 0 秒 | 極低 | 無 | 🟢 幾乎無影響 |

### ⚠️ 單次觸發的實際影響

```
T+0秒    收到 /api/crash 請求
T+0.1秒  process.exit(1) 執行
         ↓
         [服務中斷期]
         ↓
         - 進行中的請求失敗
         - 新請求被拒絕
         - WebSocket 斷線
         ↓
T+2秒    PM2/Docker 偵測到退出
T+3秒    啟動新的程序
T+4秒    應用初始化完成
T+5秒    服務恢復正常
         ↓
         [總中斷時間: 5秒]
```

---

## 💾 資料影響分析

### 1. 資料庫交易

```javascript
// 進行中的交易會如何？
app.post('/api/orders', async (req, res) => {
    const client = await pool.connect();

    try {
        await client.query('BEGIN');

        // 步驟 1: 建立訂單
        await client.query('INSERT INTO orders ...');

        // ⚠️ 如果此時 crash API 被觸發...
        // process.exit(1) → 連線中斷 → 交易自動 ROLLBACK

        // 步驟 2: 更新庫存
        await client.query('UPDATE tickets SET stock = stock - 1');

        await client.query('COMMIT');
    } catch (e) {
        await client.query('ROLLBACK');
    } finally {
        client.release();
    }
});
```

**結果**:
- ✅ PostgreSQL 會自動 ROLLBACK 未完成的交易
- ✅ 資料一致性得到保證
- ❌ 但該筆訂單會失敗（使用者需要重試）

---

### 2. 檔案上傳

```javascript
app.post('/api/upload', upload.single('file'), async (req, res) => {
    // 檔案已上傳到 /tmp/uploads/abc123.jpg

    // ⚠️ 如果此時 crash...
    // 檔案會留在磁碟，但資料庫沒有記錄
    // 造成「孤兒檔案」
});
```

**結果**:
- ⚠️ 可能產生孤兒檔案
- ⚠️ 需要定期清理機制

---

### 3. 快取狀態

```javascript
// In-memory cache
const cache = new Map();

app.get('/api/events', async (req, res) => {
    if (cache.has('events')) {
        return res.json(cache.get('events'));
    }

    // ⚠️ 如果 crash，快取會完全清空
    const events = await db.query('SELECT * FROM events');
    cache.set('events', events);
    res.json(events);
});
```

**結果**:
- ❌ In-memory 快取完全清空
- ⚠️ 重啟後第一批請求會變慢（需重建快取）

---

## 📈 系統負載影響

### CPU 使用率

```
正常運行:   ████░░░░░░  20-30%
Crash 瞬間: ██████████  100% (極短暫)
重啟初始化: ██████████  100% (1-2秒)
恢復正常:   ████░░░░░░  20-30%
```

### 記憶體使用

```
正常運行:   ████████░░  80MB
Crash:      ░░░░░░░░░░  0MB (釋放)
重啟:       ██░░░░░░░░  20MB (初始)
完全載入:   ████████░░  80MB
```

**影響**:
- ✅ 記憶體洩漏會被清除（這其實是好事）
- ⚠️ 但冷啟動需要時間

---

## 🌐 Railway 特殊影響

Railway 的重啟機制比較特殊：

```
1. 偵測到 exit(1)
   ↓
2. 標記為「異常退出」
   ↓
3. 啟動新容器
   ↓
4. 健康檢查通過後才路由流量
   ↓
5. 舊容器可能還會短暫存在

總時間: 10-20 秒
```

**影響**:
- ⚠️ 比本地 Docker 慢
- ⚠️ 可能觸發「服務不健康」警報
- ✅ 但最終會正常恢復

---

## 💰 成本影響

### 計算資源

```
重啟一次的成本（Railway）:
- 新容器啟動: ~15 秒 × $0.000X/秒 ≈ 幾乎免費
- 舊容器關閉: ~5 秒

結論: 單次 crash 成本可忽略
```

### 但是頻繁 crash 的成本

```
如果每分鐘 crash 一次:
- 每小時 60 次重啟
- 每次 15 秒 = 900 秒/小時
- 實際運行時間: 3600 - 900 = 2700 秒 (75%)

結論: 可用性降至 75%，違反 SLO
```

---

## 🎯 結論：單次觸發可接受嗎？

### ✅ 可接受的情況

1. **測試監控系統**
   - 目的：驗證 Prometheus/Grafana 是否正常運作
   - 頻率：一週一次或更少
   - 時間：非尖峰時段（凌晨）

2. **演練緊急恢復**
   - 目的：訓練團隊處理故障
   - 頻率：一個月一次
   - 條件：預先通知相關人員

3. **驗證自動重啟機制**
   - 目的：確保 PM2/Docker/K8s 正常運作
   - 頻率：系統變更後
   - 條件：有完整的監控

---

### ❌ 不可接受的情況

1. **高峰時段測試**
   - 影響大量使用者
   - 可能造成訂單失敗

2. **頻繁觸發**
   - 每天多次
   - 造成服務不穩定

3. **未通知團隊**
   - 觸發真實警報
   - 浪費 on-call 人員時間

---

## 📋 安全觸發檢查清單

如果要在生產環境觸發 crash 測試：

### 事前準備
- [ ] ✅ 選擇低流量時段（凌晨 2-4 點）
- [ ] ✅ 通知 on-call 工程師
- [ ] ✅ 確認有自動重啟機制（PM2/Docker）
- [ ] ✅ 確認監控系統正常運作
- [ ] ✅ 準備好 RUNBOOK

### 執行中
- [ ] ✅ 記錄開始時間
- [ ] ✅ 觸發 crash
- [ ] ✅ 觀察 Grafana Dashboard
- [ ] ✅ 確認服務自動恢復
- [ ] ✅ 檢查日誌

### 事後檢討
- [ ] ✅ 記錄恢復時間
- [ ] ✅ 檢查是否有失敗的請求
- [ ] ✅ 驗證警報系統是否觸發
- [ ] ✅ 更新 RUNBOOK（如有需要）

---

## 💡 建議：更安全的測試方式

### 方案 1: 使用 Staging 環境

```bash
# 在 staging 環境測試
curl -X POST https://staging.your-app.com/api/crash \
  -H "X-Crash-Token: your-token"

# 好處：
✓ 不影響生產使用者
✓ 可以頻繁測試
✓ 環境配置與生產相同
```

### 方案 2: 使用 Blue-Green 部署

```yaml
# 只 crash Blue 環境，Green 環境繼續服務
# 驗證監控系統後再切換
```

### 方案 3: 使用 Canary 部署

```yaml
# 只讓 5% 的流量到可能 crash 的 pod
# 其他 95% 不受影響
```

---

## 🎯 最終建議

### 單次觸發影響評估

| 指標 | 影響程度 | 說明 |
|------|---------|------|
| **服務中斷** | 🟡 中 | 5-15 秒 |
| **資料一致性** | 🟢 低 | PostgreSQL 自動 ROLLBACK |
| **成本** | 🟢 極低 | 幾乎免費 |
| **使用者體驗** | 🟡 中 | 正在使用的人會受影響 |
| **系統負載** | 🟢 低 | 重啟後恢復 |

### 結論

✅ **單次觸發是可接受的**，但必須：
1. 選擇低流量時段
2. 提前通知團隊
3. 確保有自動重啟機制
4. 監控恢復過程

❌ **不建議**在以下情況觸發：
1. 高峰時段（中午、晚上）
2. 正在進行大型促銷活動
3. 系統已經不穩定
4. 沒有自動重啟機制

---

**文件版本**: 1.0
**最後更新**: 2025-11-30
